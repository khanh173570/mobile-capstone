# ?? AgriMart Notification System - Complete Architecture

## ?? Table of Contents
1. [System Overview](#system-overview)
2. [Notification Types](#notification-types)
3. [Architecture Diagrams](#architecture-diagrams)
4. [Service Breakdown](#service-breakdown)
5. [Event Flow Diagrams](#event-flow-diagrams)
6. [Quick Reference](#quick-reference)

---

## ?? System Overview

### Components

```
???????????????????????????????????????????????????????????????????
?                    AgriMart Notification System                  ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
?  ????????????????  ????????????????  ????????????????          ?
?  ?   Real-time  ?  ?  Scheduled   ?  ?   Payment    ?          ?
?  ?Notifications ?  ?Notifications ?  ?Notifications ?          ?
?  ?  (SignalR)   ?  ?  (Hangfire)  ?  ?   (Events)   ?          ?
?  ????????????????  ????????????????  ????????????????          ?
?                                                                  ?
???????????????????????????????????????????????????????????????????
```

### Technology Stack

- **Real-time:** SignalR (WebSocket)
- **Scheduling:** Hangfire (Background Jobs)
- **Messaging:** MassTransit + RabbitMQ
- **Storage:** PostgreSQL
- **Caching:** Redis (optional)

---

## ?? Notification Types

### 1. Auction Notifications

| Type | Code | Severity | Trigger | Recipients |
|------|------|----------|---------|------------|
| Outbid | 1 | Warning | Someone bids higher | Previous bidders |
| Auction Ended | 2 | Info | Auction closes | All participants |
| Auction Won | 3 | Info | Win auction | Winner |
| Auction Approved | 4 | Info | Admin approves | Auctioneer (farmer) |
| Auction Paused | 5 | Warning | Admin pauses | All participants |
| Auction Started | 6 | Info | Auction goes live | Interested users |

### 2. System Notifications

| Type | Code | Severity | Purpose |
|------|------|----------|---------|
| System | 7 | Info/Warning/Error | General system messages |

### 3. Payment Notifications

| Type | Code | Severity | Trigger | Recipients |
|------|------|----------|---------|------------|
| Escrow Deposit Success | 8 | Info | Deposit paid | Wholesaler |
| Remaining Payment Success | 9 | Info | Full payment made | Wholesaler |
| Escrow Release Received | 10 | Info | Money received | Farmer |
| Wallet Funds Added | 11 | Info | Funds deposited | User |

### 4. Harvest Reminder Notifications

| ReminderDay | Severity | When | Purpose |
|-------------|----------|------|---------|
| -7 | Info | 7 days before | Early check-in |
| -3 | Warning | 3 days before | Preparation reminder |
| -1 | Warning | 1 day before | Final preparation |
| 0 | Warning | On harvest day | Action required |
| +1 | Error | 1 day overdue | Urgent update needed |

---

## ??? Architecture Diagrams

### Overall System Architecture

```
????????????????????????????????????????????????????????????????????????????
?                           Frontend Application                            ?
?                      (React/Mobile - SignalR Client)                     ?
????????????????????????????????????????????????????????????????????????????
                             ?
                             ? WebSocket Connection
                             ?
????????????????????????????????????????????????????????????????????????????
?                          Messaging.API                                    ?
?  ??????????????????  ??????????????????  ??????????????????            ?
?  ?   SignalR Hub  ?  ?  Notification  ?  ?   Scheduled    ?            ?
?  ?   (GlobalHub)  ?  ?    Service     ?  ? Notification   ?            ?
?  ?                ?  ?                ?  ?    Service     ?            ?
?  ??????????????????  ??????????????????  ??????????????????            ?
?           ?                   ?                    ?                      ?
?           ?                   ?                    ?                      ?
?           ?                   ?                    ?                      ?
?           ?          ???????????????????????????????????                 ?
?           ?          ?   Messaging PostgreSQL DB       ?                 ?
?           ?          ?  - Notifications                ?                 ?
?           ?          ?  - ScheduledNotifications       ?                 ?
?           ?          ?  - NotificationSettings         ?                 ?
?           ?          ???????????????????????????????????                 ?
????????????????????????????????????????????????????????????????????????????
            ?
            ? Real-time push
            ?
            ?
            ?
????????????????????????????????????????????????????????????????????????????
?                             RabbitMQ (MassTransit)                        ?
?                                                                           ?
?  Events:                                                                  ?
?  - CreateNotificationEvent                                                ?
?  - CreateHarvestRemindersEvent                                            ?
?  - CancelHarvestRemindersEvent                                            ?
?  - BidPlacedEvent                                                         ?
?  - AuctionEndedEvent                                                      ?
?  - Payment Events (EscrowDepositSuccess, etc.)                            ?
????????????????????????????????????????????????????????????????????????????
              ?                  ?                  ?
              ?                  ?                  ?
    ??????????????????? ??????????????????? ???????????????????
    ?  Auction.API    ? ?  Payment.API    ? ?   Worker        ?
    ?                 ? ?                 ? ?  Background     ?
    ? - Bid events    ? ? - Payment events? ?                 ?
    ? - Auction mgmt  ? ? - Escrow mgmt   ? ? - Hangfire Jobs ?
    ??????????????????? ??????????????????? ???????????????????
```

### Real-time Notification Flow

```
????????????      ????????????      ????????????      ????????????
?  Auction ?      ? RabbitMQ ?      ?Messaging ?      ? Frontend ?
?  Service ?      ?          ?      ?   .API   ?      ?   User   ?
????????????      ????????????      ????????????      ????????????
     ?                 ?                  ?                  ?
     ? 1. User places  ?                  ?                  ?
     ?    bid          ?                  ?                  ?
     ???????????????????                  ?                  ?
     ?                 ?                  ?                  ?
     ? 2. Publish      ?                  ?                  ?
     ?    BidPlacedEvent                  ?                  ?
     ?????????????????>?                  ?                  ?
     ?                 ?                  ?                  ?
     ?                 ? 3. Route to      ?                  ?
     ?                 ?    Consumer      ?                  ?
     ?                 ??????????????????>?                  ?
     ?                 ?                  ?                  ?
     ?                 ?                  ? 4. Create        ?
     ?                 ?                  ?    Notification  ?
     ?                 ?                  ?    in DB         ?
     ?                 ?                  ?                  ?
     ?                 ?                  ? 5. Send via      ?
     ?                 ?                  ?    SignalR       ?
     ?                 ?                  ??????????????????>?
     ?                 ?                  ?                  ?
     ?                 ?                  ?                  ? 6. Display
     ?                 ?                  ?                  ?    notification
     ?                 ?                  ?                  ?    to user
```

### Scheduled Notification Flow

```
Day -7           Day -3           Day -1           Day 0            Day +1
  ?                ?                ?                ?                ?
  ? Info           ? Warning        ? Warning        ? Warning        ? Error
  ? 08:00          ? 08:00          ? 08:00          ? 07:00          ? 09:00
  ?                ?                ?                ?                ?
  ?                ?                ?                ?                ?
??????????????????????????????????????????????????????????????????????????
?                      Background Job (Hangfire)                         ?
?                   Runs every 5 minutes                                 ?
?                                                                        ?
?  1. Query: SELECT * FROM ScheduledNotifications                        ?
?            WHERE Status = Pending                                      ?
?            AND ScheduledAt <= NOW()                                    ?
?                                                                        ?
?  2. For each notification:                                             ?
?     - Publish CreateNotificationEvent                                  ?
?     - Update Status = Sent, SentAt = NOW()                             ?
?                                                                        ?
?  3. Error handling:                                                    ?
?     - On failure: Status = Failed, FailureReason = error               ?
??????????????????????????????????????????????????????????????????????????
                              ?
                              ? CreateNotificationEvent
                              ?
                    ????????????????????
                    ?  Messaging.API   ?
                    ?                  ?
                    ?  - Save to DB    ?
                    ?  - Push SignalR  ?
                    ????????????????????
```

### Payment Notification Flow

```
Wholesaler            Payment.API          Messaging.API          Farmer
    ?                      ?                      ?                  ?
    ? 1. Pay Deposit      ?                      ?                  ?
    ?????????????????????>?                      ?                  ?
    ?   (Wallet/PayOS)    ?                      ?                  ?
    ?                     ?                      ?                  ?
    ?                     ? 2. Update Escrow     ?                  ?
    ?                     ?    Status =          ?                  ?
    ?                     ?    PartiallyFunded   ?                  ?
    ?                     ?                      ?                  ?
    ?                     ? 3. Publish Events    ?                  ?
    ?                     ?    - CreateNotificationEvent            ?
    ?                     ?    - CreateHarvestRemindersEvent        ?
    ?                     ??????????????????????>?                  ?
    ?                     ?                      ?                  ?
    ? 4. Notification     ?                      ? 5. Create 5      ?
    ?    "Deposit         ?                      ?    Scheduled     ?
    ?    Success"         ?                      ?    Notifications ?
    ?<??????????????????????????????????????????                  ?
    ?                     ?                      ?                  ?
    ?                     ?                      ? 6. (Days later)  ?
    ?                     ?                      ?    Send          ?
    ?                     ?                      ?    reminders     ?
    ?                     ?                      ??????????????????>?
    ?                     ?                      ?                  ?
    ?                     ?                      ?                  ? Farmer
    ?                     ?                      ?                  ? receives
    ?                     ?                      ?                  ? reminders
```

---

## ?? Service Breakdown

### Messaging.API

**Responsibilities:**
- Manage notification CRUD operations
- Real-time push via SignalR
- Schedule notification management
- Process notification events from other services

**Key Components:**
- `NotificationService` - CRUD for notifications
- `ScheduledNotificationService` - Manage scheduled notifications
- `NotificationSettingsService` - User preferences
- `GlobalHub` - SignalR hub for real-time push
- `Notifier` - Helper to send SignalR messages

**Endpoints:**
```
GET    /Notifications                    - Get user's notifications
GET    /Notifications/{id}               - Get specific notification
POST   /Notifications/mark-read/{id}     - Mark as read
POST   /Notifications/mark-all-read      - Mark all as read
GET    /Notifications/unread-count       - Get unread count
```

**Consumers:**
- `CreateNotificationEventConsumer` - Create notification from event
- `CreateHarvestRemindersEventConsumer` - Create scheduled reminders
- `CancelHarvestRemindersEventConsumer` - Cancel scheduled reminders

---

### Payment.API

**Responsibilities:**
- Process payments (Wallet, PayOS)
- Manage escrows
- Trigger payment notifications
- Trigger harvest reminder scheduling

**Events Published:**
- `CreateNotificationEvent` (payment success)
- `CreateHarvestRemindersEvent` (on deposit)
- `CancelHarvestRemindersEvent` (on ready to harvest)

**Key Services:**
- `EscrowService` - Escrow management
- `PayOSService` - PayOS integration
- `TransactionService` - Transaction processing
- `WalletService` - Wallet operations

---

### Auction.API

**Responsibilities:**
- Manage auctions and bids
- Provide auction data to other services
- Trigger auction-related notifications

**Events Published:**
- `BidPlacedEvent`
- `AuctionEndedEvent`
- `AuctionApprovedEvent`
- `AuctionPausedEvent`

**Consumers:**
- `GetAuctionExpectedHarvestDateConsumer` - Respond with harvest date

---

### Worker (Background Service)

**Responsibilities:**
- Run scheduled jobs
- Process pending notifications
- Cleanup expired data

**Jobs:**
- `ProcessScheduledNotificationsJob` - Send scheduled notifications
- `CloseExpiredAuctionsJob` - Close finished auctions
- `PublishAuctionJob` - Publish scheduled auctions

**Schedule:**
```
ProcessScheduledNotifications: */5 * * * *  (Every 5 minutes)
CloseExpiredAuctions:         */1 * * * *  (Every minute)
PublishAuction:               */1 * * * *  (Every minute)
```

---

## ?? Event Flow Diagrams

### Flow 1: Escrow Deposit Payment (Wallet) ? Harvest Reminders

```
????????????????
? Wholesaler   ?
? pays deposit ?
? via Wallet   ?
????????????????
       ?
       ?
??????????????????????????????????????????
? EscrowService.PayEscrowUsingWalletAsync?
?                                        ?
? 1. Validate wallet balance            ?
? 2. Create transaction                 ?
? 3. Update ledgers                     ?
? 4. Update escrow status               ?
? 5. Commit transaction                 ?
??????????????????????????????????????????
       ?
       ???> Publish CreateNotificationEvent
       ?    (Deposit Success to Wholesaler)
       ?
       ???> Publish CreateHarvestRemindersEvent
                   ?
                   ?
       ?????????????????????????????????????
       ?CreateHarvestRemindersEventConsumer?
       ?                                   ?
       ? 1. Check if AuctionId exists      ?
       ? 2. Request from Auction:          ?
       ?    - ExpectedHarvestDate          ?
       ?    - FarmerId                     ?
       ? 3. Create 5 ScheduledNotifications?
       ?    in DB                          ?
       ?????????????????????????????????????
```

### Flow 2: Farmer Marks Ready ? Cancel Reminders

```
????????????????
?  Farmer      ?
? clicks       ?
? "Ready to    ?
?  Harvest"    ?
????????????????
       ?
       ?
???????????????????????????????????????????
?EscrowService.SetEscrowToReadyToHarvest  ?
?                                         ?
? 1. Validate escrow status               ?
? 2. Update escrow ? ReadyToHarvest       ?
? 3. Publish crop status update event    ?
???????????????????????????????????????????
       ?
       ???> Publish CancelHarvestRemindersEvent
                   ?
                   ?
       ?????????????????????????????????????
       ?CancelHarvestRemindersEventConsumer?
       ?                                   ?
       ? 1. Find all ScheduledNotifications?
       ?    WHERE EscrowId = {id}          ?
       ?    AND Status = Pending           ?
       ? 2. Update Status = Cancelled      ?
       ?????????????????????????????????????
```

### Flow 3: Background Job Sends Scheduled Notification

```
????????????????????????????????????????
?  Hangfire Scheduler                  ?
?  (Every 5 minutes)                   ?
????????????????????????????????????????
       ?
       ?
????????????????????????????????????????
? ProcessScheduledNotificationsJob     ?
?                                      ?
? Query:                               ?
? SELECT * FROM ScheduledNotifications ?
? WHERE Status = Pending               ?
?   AND ScheduledAt <= NOW()           ?
????????????????????????????????????????
       ?
       ? For each notification:
       ?
????????????????????????????????????????
? 1. Create CreateNotificationEvent    ?
?    - UserId                          ?
?    - Type, Severity                  ?
?    - Title, Message                  ?
?                                      ?
? 2. Publish to RabbitMQ               ?
????????????????????????????????????????
       ?
       ?
????????????????????????????????????????
? CreateNotificationEventConsumer      ?
?                                      ?
? 1. Save to Notifications table       ?
? 2. Send via SignalR to user          ?
????????????????????????????????????????
       ?
       ?
????????????????????????????????????????
? Update ScheduledNotification:        ?
? - Status = Sent                      ?
? - SentAt = NOW()                     ?
????????????????????????????????????????
```

---

## ?? Quick Reference

### Database Tables

```sql
-- Real-time notifications
Notifications (
    Id, UserId, Type, Severity,
    Title, Message, Data,
    IsRead, ReadAt,
    RelatedEntityId, RelatedEntityType,
    CreatedAt, UpdatedAt
)

-- Scheduled notifications
ScheduledNotifications (
    Id, UserId, Type, Severity,
    Title, Message, Data,
    ScheduledAt, Status, SentAt, FailureReason,
    EscrowId, ReminderDay,
    RelatedEntityId, RelatedEntityType,
    CreatedAt, UpdatedAt
)

-- User preferences
NotificationSettings (
    Id, UserId,
    EmailEnabled, PushEnabled, InAppEnabled,
    NotificationTypes,
    CreatedAt, UpdatedAt
)
```

### Key Enums

```csharp
// Notification Types
NotificationType {
    Outbid = 1,
    AuctionEnded = 2,
    AuctionWon = 3,
    AuctionApproved = 4,
    AuctionPaused = 5,
    AuctionStarted = 6,
    System = 7,
    EscrowDepositSuccess = 8,
    EscrowRemainingPaymentSuccess = 9,
    EscrowReleaseReceived = 10,
    WalletFundsAdded = 11
}

// Severity Levels
NotificationSeverity {
    Info = 1,
    Warning = 2,
    Error = 3
}

// Scheduled Status
ScheduledNotificationStatus {
    Pending = 0,
    Sent = 1,
    Cancelled = 2,
    Failed = 3
}
```

### Important Events

| Event | Publisher | Consumer | Purpose |
|-------|-----------|----------|---------|
| CreateNotificationEvent | Any service | Messaging.API | Create & send notification |
| CreateHarvestRemindersEvent | Payment.API | Messaging.API | Schedule 5 reminders |
| CancelHarvestRemindersEvent | Payment.API | Messaging.API | Cancel scheduled reminders |
| GetAuctionExpectedHarvestDateRequest | Messaging.API | Auction.API | Get harvest date |
| BidPlacedEvent | Auction.API | Worker | Process bid notifications |

### Configuration Points

```csharp
// SignalR Hub URL
/globalhub

// SignalR Methods
- SendToUserAsync(userId, type, message)
- SendToAllAsync(type, message)

// Hangfire Jobs
- ProcessScheduledNotifications: */5 * * * *
- CloseExpiredAuctions: */1 * * * *

// RabbitMQ Exchanges
- messaging (CreateNotificationEvent)
- auction (Bid events)
- payment (Payment events)
```

---

## ?? Related Documentation

- [Scheduled Harvest Reminders](./SCHEDULED_HARVEST_REMINDERS.md) - Detailed implementation
- [Payment Flow](./PAYMENT_FLOW.md) - Payment & escrow documentation
- [SignalR Integration](./SIGNALR_INTEGRATION.md) - Real-time communication
- [Event Bus](./EVENT_BUS.md) - RabbitMQ & MassTransit setup

---

**Version:** 2.0  
**Last Updated:** December 2024  
**Maintainer:** Backend Team
