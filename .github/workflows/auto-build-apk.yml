name: Auto Build & Update APK

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - '.github/workflows/eas-update.yml'
      - 'AUTO_*.md'
  workflow_dispatch: # Manual trigger

jobs:
  build-and-update:
    name: Build APK & Update Landing
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing to repo
      actions: read
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: |
          npm cache clean --force
          npm install

      - name: Build APK
        run: |
          echo "ğŸš€ Starting APK build..."
          eas build --platform android --non-interactive --wait
        timeout-minutes: 30
        
      - name: Get latest build info
        id: build_info
        run: |
          echo "ğŸ” Getting latest build info..."
          
          # Short wait for EAS API sync
          sleep 10
          
          # Simple and fast - 3 attempts only
          for i in {1..3}; do
            echo "ğŸ“¡ Attempt $i..."
            
            BUILD_INFO=$(eas build:list --platform=android --limit=1 --json --non-interactive 2>/dev/null || echo "[]")
            
            if echo "$BUILD_INFO" | jq empty 2>/dev/null; then
              BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.[0].artifacts.buildUrl // empty' 2>/dev/null)
              BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.[0].id // empty' 2>/dev/null)
              
              if [[ -n "$BUILD_URL" && "$BUILD_URL" != "null" && "$BUILD_URL" != "empty" ]]; then
                echo "âœ… Found latest build!"
                echo "Build ID: $BUILD_ID"  
                echo "Build URL: $BUILD_URL"
                
                echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
                echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
            
            # Very short wait between retries
            echo "âš ï¸ Attempt $i failed, waiting 5s before retry..."
            sleep 5
          done
          
          # Last resort: Try text-based extraction
          echo "ğŸ”„ Trying text-based build list extraction..."
          BUILD_LIST=$(eas build:list --platform=android --limit=1 --non-interactive 2>/dev/null || echo "")
          
          if [[ -n "$BUILD_LIST" ]]; then
            echo "ğŸ“‹ Available builds:"
            echo "$BUILD_LIST"
            
            # Extract APK URL from text output
            BUILD_URL=$(echo "$BUILD_LIST" | grep -o 'https://expo\.dev/artifacts/eas/[^[:space:]]*\.apk' | head -1 || echo "")
            
            if [[ -n "$BUILD_URL" ]]; then
              BUILD_ID="text-extract-$(date +%s)"
              echo "âœ… Extracted build URL: $BUILD_URL"
              echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
              echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "âŒ Failed to get build info after all attempts"
          echo "This might be a temporary EAS API issue"
          exit 1

      - name: Update landing page with new APK link
        run: |
          echo "ğŸ”„ Current APK link in landing page:"
          grep -n "expo.dev/artifacts" index.html || echo "No current APK link found"
          
          # Fix: Match the href attribute specifically with proper escaping
          sed -i 's|href="https://expo\.dev/artifacts/eas/[^"]*"|href="${{ steps.build_info.outputs.build_url }}"|g' index.html
          
          echo "âœ… Updated landing page with new APK link:"
          grep -n "expo.dev/artifacts" index.html || echo "No APK link after update"
          
          # Debug: Show what build_url contains
          echo "ğŸ” Build URL to insert: ${{ steps.build_info.outputs.build_url }}"
          
          # Verify the change worked
          if grep -q "${{ steps.build_info.outputs.build_url }}" index.html; then
            echo "âœ… Successfully updated APK link!"
          else
            echo "âŒ Failed to update APK link"
            echo "Current content around APK link:"
            grep -A2 -B2 "expo.dev" index.html || echo "No matches found"
          fi

      - name: Commit and push updated landing page
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add index.html
            git commit -m "ğŸ¤– Auto-update APK download link (Build: ${{ steps.build_info.outputs.build_id }})"
            git push
            echo "âœ… Landing page updated with new APK link!"
          fi

      - name: Auto-sync gh-pages branch
        run: |
          echo "ğŸ”„ Auto-syncing gh-pages branch with updated APK link..."
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Fetch all branches
          git fetch origin
          
          # Check if gh-pages branch exists
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "ğŸ“‹ gh-pages branch exists, checking it out..."
            git checkout gh-pages
            git pull origin gh-pages
          else
            echo "ğŸ“‹ gh-pages branch doesn't exist, creating it..."
            git checkout -b gh-pages
          fi
          
          # Copy updated index.html from main
          echo "ğŸ“„ Copying updated index.html from main..."
          git show main:index.html > index.html
          
          # Show what we're about to commit
          echo "ğŸ” Changes to be committed:"
          git diff --name-only || echo "No changes detected"
          
          # Check if there are changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "âœ… gh-pages already up to date with main"
          else
            git add index.html
            git commit -m "ğŸ¤– Auto-sync APK link from main (Build: ${{ steps.build_info.outputs.build_id }})"
            git push origin gh-pages
            echo "âœ… gh-pages branch synced successfully!"
            
            # Show the updated APK link
            echo "ğŸ“‹ Updated APK link in gh-pages:"
            grep -n "expo.dev/artifacts" index.html || echo "No APK link found"
          fi
          
          # Switch back to main
          git checkout main

      - name: Create OTA Update
        run: eas update --auto --non-interactive