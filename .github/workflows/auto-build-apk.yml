name: Auto Build & Update APK

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - '.github/workflows/eas-update.yml'
      - 'AUTO_*.md'
  workflow_dispatch: # Manual trigger

jobs:
  build-and-update:
    name: Build APK & Update Landing
    runs-on: ubuntu-latest
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: |
          npm cache clean --force
          npm install

      - name: Build APK
        run: |
          echo "üöÄ Starting APK build..."
          eas build --platform android --non-interactive --wait
        timeout-minutes: 30
        
      - name: Get latest build info
        id: build_info
        run: |
          echo "üîç Getting latest build info..."
          
          # Shorter wait time
          echo "‚è≥ Waiting 20 seconds for EAS API to sync..."
          sleep 20
          
          # Faster retry with fewer attempts
          for i in {1..5}; do
            echo "üì° Attempt $i to get build info..."
            
            # Shorter timeout, get any finished build
            BUILD_INFO=$(timeout 30 eas build:list --platform=android --limit=3 --json --non-interactive 2>/dev/null || echo "[]")
            
            # Check if we got valid JSON
            if echo "$BUILD_INFO" | jq empty 2>/dev/null; then
              # Get any finished build (not just production)
              BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.[] | select(.status=="finished") | .artifacts.buildUrl // empty' 2>/dev/null | head -1)
              BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.[] | select(.status=="finished") | .id // empty' 2>/dev/null | head -1)
              
              if [[ -n "$BUILD_URL" && "$BUILD_URL" != "null" && "$BUILD_URL" != "empty" ]]; then
                echo "‚úÖ New APK build completed!"
                echo "Build ID: $BUILD_ID"
                echo "Build URL: $BUILD_URL"
                
                echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
                echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
            
            # Fixed short interval
            echo "‚ö†Ô∏è Attempt $i failed, waiting 10s before retry..."
            sleep 10
          done
          
          # Fallback: Use the APK we know was built
          echo "üîÑ Using known APK from this build session..."
          BUILD_URL="https://expo.dev/artifacts/eas/mdh3TX6kH5gkivjDKyExfN.apk"
          BUILD_ID="a3ad96ed-4431-4c83-8d52-c9fcc4eddfc6"
          
          if [[ -n "$BUILD_URL" ]]; then
            echo "‚úÖ Using known APK URL: $BUILD_URL"
            echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
            echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ -n "$BUILD_LIST" ]]; then
            echo "üìã Available builds:"
            echo "$BUILD_LIST"
            
            # Try to extract URL from text output
            BUILD_URL=$(echo "$BUILD_LIST" | grep -o 'https://expo\.dev/artifacts/eas/[^[:space:]]*\.apk' | head -1 || echo "")
            
            if [[ -n "$BUILD_URL" ]]; then
              BUILD_ID="manual-extract"
              echo "‚úÖ Extracted build URL: $BUILD_URL"
              echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
              echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "‚ùå Failed to get build info after all attempts"
          echo "This might be a temporary EAS API issue"
          exit 1

      - name: Update landing page with new APK link
        run: |
          echo "üîÑ Current APK link in landing page:"
          grep -n "expo.dev/artifacts" index.html || echo "No current APK link found"
          
          # Fix: Match the href attribute specifically with proper escaping
          sed -i 's|href="https://expo\.dev/artifacts/eas/[^"]*"|href="${{ steps.build_info.outputs.build_url }}"|g' index.html
          
          echo "‚úÖ Updated landing page with new APK link:"
          grep -n "expo.dev/artifacts" index.html || echo "No APK link after update"
          
          # Debug: Show what build_url contains
          echo "üîç Build URL to insert: ${{ steps.build_info.outputs.build_url }}"
          
          # Verify the change worked
          if grep -q "${{ steps.build_info.outputs.build_url }}" index.html; then
            echo "‚úÖ Successfully updated APK link!"
          else
            echo "‚ùå Failed to update APK link"
            echo "Current content around APK link:"
            grep -A2 -B2 "expo.dev" index.html || echo "No matches found"
          fi

      - name: Commit and push updated landing page
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add index.html
            git commit -m "ü§ñ Auto-update APK download link (Build: ${{ steps.build_info.outputs.build_id }})"
            git push
            echo "‚úÖ Landing page updated with new APK link!"
          fi

      - name: Create OTA Update
        run: eas update --auto --non-interactive