name: Auto Build Android App

on:
  push:
    branches:
      - main
      - PhuongKhanh  # Branch hiá»‡n táº¡i cá»§a báº¡n
    tags:
      - 'v*.*.*'  # Tag version nhÆ° v1.0.0, v1.0.1
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng tá»« GitHub UI

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ— Checkout code
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: ğŸ— Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Build Preview APK (for testing)
        run: |
          eas build --platform android --profile preview --non-interactive --no-wait
        
      - name: ğŸ“ Build info
        run: |
          echo "âœ… Build started successfully!"
          echo "ğŸ“± Platform: Android"
          echo "ğŸ”§ Profile: Preview (APK)"
          echo "â° Build will take ~15-20 minutes"
          echo "ğŸ”— Check progress at: https://expo.dev/accounts/khanhtpse173570/projects/agrimart-shop/builds"

  # Job riÃªng Ä‘á»ƒ build Production AAB (chá»‰ cháº¡y khi cÃ³ tag)
  build-production:
    name: Build Production AAB
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')  # Chá»‰ cháº¡y khi push tag
    
    steps:
      - name: ğŸ— Checkout code
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: ğŸ— Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Build Production AAB
        run: |
          eas build --platform android --profile production --non-interactive --no-wait
        
      - name: ğŸ“ Build info
        run: |
          echo "âœ… Production build started!"
          echo "ğŸ“± Platform: Android"
          echo "ğŸ”§ Profile: Production (AAB)"
          echo "ğŸ·ï¸ Version: ${{ github.ref_name }}"
          echo "â° Build will take ~15-20 minutes"
          echo "ğŸ”— Check progress at: https://expo.dev/accounts/khanhtpse173570/projects/agrimart-shop/builds"
